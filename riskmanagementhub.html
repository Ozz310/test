<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Management Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="calculator-container">
        <h1 class="text-3xl font-bold text-center mb-6" style="color: #F0D788;">Risk Management Hub</h1>
        <div class="message-box" id="messageBox">
            <span id="messageText"></span>
            <button class="message-box-close" onclick="hideMessage()">&times;</button>
        </div>
        
        <div class="two-column-layout">
            <div class="calculator-section margin-calc">
                <h2 class="text-xl font-bold mb-4" style="color: #F0D788;">1. Margin Calculator</h2>
                <p class="api-note"><i class="fas fa-info-circle"></i> This section uses an external API.</p>
                <div class="input-group">
                    <label for="accountCurrency">Account Currency:</label>
                    <select id="accountCurrency">
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - British Pound</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="AUD">AUD - Australian Dollar</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="CHF">CHF - Swiss Franc</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="leverage">Leverage:</label>
                    <select id="leverage">
                        <option value="1">1:1</option>
                        <option value="10">1:10</option>
                        <option value="25">1:25</option>
                        <option value="50">1:50</option>
                        <option value="100" selected>1:100</option>
                        <option value="200">1:200</option>
                        <option value="400">1:400</option>
                        <option value="500">1:500</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="currencyPair">Instrument:</label>
                    <select id="currencyPair">
                        <optgroup label="Forex (Major)">
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                        </optgroup>
                        <optgroup label="Forex (Crosses)">
                            <option value="EURGBP">EUR/GBP</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="AUDJPY">AUD/JPY</option>
                            <option value="EURAUD">EUR/AUD</option>
                            <option value="CADJPY">CAD/JPY</option>
                        </optgroup>
                        <optgroup label="Metals">
                            <option value="XAUUSD">XAU/USD (Gold)</option>
                            <option value="XAGUSD">XAG/USD (Silver)</option>
                        </optgroup>
                        <optgroup label="Stocks (CFDs - Example)">
                            <option value="AAPL">AAPL (Apple Inc)</option>
                            <option value="TSLA">TSLA (Tesla Inc)</option>
                            <option value="GOOGL">GOOGL (Alphabet Inc)</option>
                        </optgroup>
                        <optgroup label="Indices (CFDs - Example)">
                            <option value="US30">US30 (Dow Jones)</option>
                            <option value="SPX500">SPX500 (S&P 500)</option>
                            <option value="NAS100">NAS100 (Nasdaq 100)</option>
                            <option value="UK100">UK100 (FTSE 100)</option>
                        </optgroup>
                        <optgroup label="Cryptocurrencies (CFDs - Example)">
                            <option value="BTCUSD">BTC/USD (Bitcoin)</option>
                            <option value="ETHUSD">ETH/USD (Ethereum)</option>
                            <option value="XRPUSD">XRP/USD (Ripple)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="input-group">
                    <label for="tradeSize" id="tradeSizeLabel">Trade Size (Units):</label>
                    <input type="number" id="tradeSize" value="100000" min="0.01" step="0.01">
                </div>
            </div>

            <div class="calculator-section risk-calc">
                <h2 class="text-xl font-bold mb-4" style="color: #F0D788;">2. Position Size & R/R</h2>
                <p class="api-note"><i class="fas fa-info-circle"></i> This section works offline.</p>
                <div class="input-group">
                    <label for="capital">Total Capital ($):</label>
                    <input type="number" id="capital" placeholder="e.g., 5000" min="1" step="any">
                </div>
                <div class="input-group">
                    <label for="risk_percent">Risk Per Trade (%):</label>
                    <input type="number" id="risk_percent" placeholder="e.g., 1 or 2" min="0.1" max="100" step="any">
                </div>
                <div class="input-group">
                    <label for="entry_price">Entry Price:</label>
                    <input type="number" id="entry_price" placeholder="e.g., 1.25000" min="0.00001" step="any">
                </div>
                <div class="input-group">
                    <label for="stop_loss_price">Stop Loss Price:</label>
                    <input type="number" id="stop_loss_price" placeholder="e.g., 1.24800" min="0.00001" step="any">
                </div>
                <div class="input-group">
                    <label for="take_profit_price">Take Profit Price:</label>
                    <input type="number" id="take_profit_price" placeholder="e.g., 1.26000" min="0.00001" step="any">
                </div>
            </div>
        </div>

        <button onclick="calculateAll()">
            <span class="loading-spinner" id="loadingSpinner"></span>
            Calculate All
        </button>

        <div class="result-area" id="resultArea">
            <h2 class="text-xl font-bold mb-4" style="color: #F0D788;">Calculation Results</h2>
            <div class="results-grid">
                <div>
                    <p>Current Rate: (<span id="ratePairDisplay">EUR/USD</span>): <span id="currentRateDisplay">Fetching...</span></p>
                    <p>Required Margin: <span id="requiredMarginDisplay">0.00</span> <span id="marginCurrencySymbol">USD</span></p>
                    <p>Pip/Point Value: <span id="pipValueDisplay">N/A</span> <span id="pipValueCurrencySymbol"></span></p>
                </div>
                <div>
                    <p>Risk Amount: <span id="risk_amount"></span></p>
                    <p>Stop Loss Pips: <span id="stop_loss_pips"></span></p>
                    <p>Recommended Units: <span id="recommended_units"></span></p>
                    <p>R/R Ratio: <span id="rr_ratio"></span></p>
                </div>
            </div>
        </div>

        <div class="branding">
            <img src="https://raw.githubusercontent.com/Ozz310/TradersGazette/refs/heads/main/calculator/WhatsApp%20Image%202025-06-18%20at%2011.37.15%20(1).jpeg"
                alt="The Traders Gazette Logo"
                onerror="this.src='https://placehold.co/180x50/1a1a1a/F0D788?text=The+Traders+Gazette+Logo+Placeholder';">
            <p>Powered by The Trader's Gazette</p>
        </div>
    </div>
    <script>
        // --- API Keys (API-Based Margin Calculator Only) ---
        const API_KEY = "wsgm72NBgI3iTLj64psT";
        const API_BASE_URL = "https://marketdata.tradermade.com/api/v1/live";

        // --- DOM Elements ---
        const accountCurrencySelect = document.getElementById('accountCurrency');
        const leverageSelect = document.getElementById('leverage');
        const currencyPairSelect = document.getElementById('currencyPair');
        const tradeSizeInput = document.getElementById('tradeSize');
        const tradeSizeLabel = document.getElementById('tradeSizeLabel');
        const ratePairDisplay = document.getElementById('ratePairDisplay');
        const currentRateDisplay = document.getElementById('currentRateDisplay');
        const requiredMarginDisplay = document.getElementById('requiredMarginDisplay');
        const marginCurrencySymbol = document.getElementById('marginCurrencySymbol');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const pipValueRow = document.getElementById('pipValueRow');
        const pipValueDisplay = document.getElementById('pipValueDisplay');
        const pipValueCurrencySymbol = document.getElementById('pipValueCurrencySymbol');
        const capitalInput = document.getElementById('capital');
        const riskPercentInput = document.getElementById('risk_percent');
        const entryPriceInput = document.getElementById('entry_price');
        const stopLossPriceInput = document.getElementById('stop_loss_price');
        const takeProfitPriceInput = document.getElementById('take_profit_price');
        const resultsArea = document.getElementById('resultArea');
        const rrRatioDisplay = document.getElementById('rr_ratio');
        const recommendedUnitsDisplay = document.getElementById('recommended_units');
        const stopLossPipsDisplay = document.getElementById('stop_loss_pips');
        const riskAmountDisplay = document.getElementById('risk_amount');

        // --- Initial Load ---
        window.onload = fetchAndDisplayInitialRate;
        currencyPairSelect.addEventListener('change', () => {
            fetchAndDisplayInitialRate();
        });
        
        // --- Message Box Functions ---
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.classList.add('show');
            messageBox.style.backgroundColor = (type === 'error') ? '#d32f2f' : '#333';
        }
        function hideMessage() { messageBox.classList.remove('show'); }
        function showLoading() { loadingSpinner.classList.add('show'); }
        function hideLoading() { loadingSpinner.classList.remove('show'); }
        
        // --- API-Based Margin Calculator Logic ---
        async function fetchForexRate(symbol) {
            hideMessage();
            showLoading();
            try {
                const url = `${API_BASE_URL}?currency=${symbol}&api_key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.quotes && data.quotes.length > 0) {
                    const quote = data.quotes[0];
                    const rate = quote.bid;
                    if (rate) {
                        currentRateDisplay.textContent = rate.toFixed(5);
                        return rate;
                    } else {
                        showMessage(`Could not find live rate for ${symbol}.`, 'error');
                        currentRateDisplay.textContent = 'N/A';
                        return null;
                    }
                } else if (data.error) {
                    showMessage(`API Error for ${symbol}: ${data.error}`, 'error');
                    currentRateDisplay.textContent = 'N/A';
                    return null;
                } else {
                    showMessage(`No data received for ${symbol}. Check symbol or API key.`, 'error');
                    currentRateDisplay.textContent = 'N/A';
                    return null;
                }
            } catch (error) {
                console.error("Error fetching rate for", symbol, ":", error);
                showMessage(`Failed to fetch live rate for ${symbol}. Check your internet connection or API key.`, 'error');
                currentRateDisplay.textContent = 'Error';
                return null;
            } finally {
                hideLoading();
            }
        }
        async function fetchAndDisplayInitialRate() {
            const selectedSymbol = currencyPairSelect.value;
            ratePairDisplay.textContent = selectedSymbol.replace(/([A-Z]{3})(USD|EUR|GBP|JPY)/, '$1/$2');
            await fetchForexRate(selectedSymbol);
        }
        function calculateMargin(currentPrice) {
            const accountCurrency = accountCurrencySelect.value;
            const leverage = parseFloat(leverageSelect.value);
            const selectedSymbol = currencyPairSelect.value;
            const tradeSizeUnits = parseFloat(tradeSizeInput.value);
            
            if (isNaN(tradeSizeUnits) || tradeSizeUnits <= 0 || leverage <= 0) {
                return showMessage("Please enter valid inputs for Margin.", 'error');
            }
            if (currentPrice === null) return;
            
            const { quote: quoteCurrencyOfPair } = parseSymbol(selectedSymbol);
            let marginRequiredInBaseCurrency = (currentPrice * tradeSizeUnits) / leverage;
            let marginBaseCurrency = quoteCurrencyOfPair;
            
            if (marginBaseCurrency !== accountCurrency) {
                 showMessage(`Cannot convert margin to ${accountCurrency} without a conversion rate. Showing margin in ${marginBaseCurrency}.`, 'error');
                 marginCurrencySymbol.textContent = marginBaseCurrency;
            } else {
                marginCurrencySymbol.textContent = accountCurrency;
            }
            
            requiredMarginDisplay.textContent = marginRequiredInBaseCurrency.toFixed(2);
            
            const { pipSize, valueLabel, isPipCalculable } = getPipPointDetails(selectedSymbol);
            if (isPipCalculable) {
                const pipPointValue = (tradeSizeUnits * pipSize).toFixed(2);
                pipValueDisplay.textContent = pipPointValue;
                pipValueCurrencySymbol.textContent = (quoteCurrencyOfPair === 'JPY' ? 'JPY' : 'USD');
                pipValueRow.style.display = 'flex';
            } else {
                pipValueDisplay.textContent = valueLabel;
                pipValueCurrencySymbol.textContent = '';
                pipValueRow.style.display = 'flex';
            }
        }

        // --- Client-Side Risk Calculators Logic (NO API CALLS) ---
        function calculateRisk(currentPrice) {
            const capital = parseFloat(capitalInput.value);
            const riskPercent = parseFloat(riskPercentInput.value);
            const entryPrice = parseFloat(entryPriceInput.value);
            const stopLossPrice = parseFloat(stopLossPriceInput.value);
            const takeProfitPrice = parseFloat(takeProfitPriceInput.value);
            
            if (isNaN(capital) || isNaN(riskPercent) || isNaN(entryPrice) || isNaN(stopLossPrice)) {
                 return showMessage("Please enter valid inputs for the Risk Calculators.", 'error');
            }
            if (capital <= 0 || riskPercent <= 0 || entryPrice <= 0 || stopLossPrice <= 0) {
                return showMessage("All risk values must be positive.", 'error');
            }
            if (riskPercent > 100) {
                 return showMessage("Risk percent cannot exceed 100.", 'error');
            }
            if (entryPrice === stopLossPrice) {
                 return showMessage("Entry and Stop Loss cannot be the same.", 'error');
            }
            
            const riskAmount = capital * (riskPercent / 100);
            
            let stopLossPips = Math.abs(entryPrice - stopLossPrice);
            if (entryPrice.toString().includes('.') && entryPrice.toString().split('.')[1].length >= 4) {
                 stopLossPips = stopLossPips * 10000;
            }
            
            const recommendedUnits = riskAmount / Math.abs(entryPrice - stopLossPrice);
            
            let rrRatio = 'N/A';
            if (!isNaN(takeProfitPrice) && takeProfitPrice > 0 && Math.abs(entryPrice - stopLossPrice) !== 0) {
                 rrRatio = (Math.abs(entryPrice - takeProfitPrice) / Math.abs(entryPrice - stopLossPrice)).toFixed(2);
            }
            
            riskAmountDisplay.textContent = `$${riskAmount.toFixed(2)}`;
            stopLossPipsDisplay.textContent = stopLossPips.toFixed(2);
            recommendedUnitsDisplay.textContent = recommendedUnits.toFixed(2);
            rrRatioDisplay.textContent = `1:${rrRatio}`;
            
            posSizeResultsOutput.style.display = 'block';
        }
        
        // --- Master Calculation Function ---
        async function calculateAll() {
            hideMessage();
            showLoading();
            
            const selectedSymbol = currencyPairSelect.value;
            const currentPrice = await fetchForexRate(selectedSymbol);
            
            if (currentPrice !== null) {
                calculateMargin(currentPrice);
            }
            
            calculateRisk(currentPrice);

            hideLoading();
            resultsArea.style.display = 'block';
        }
        
        // --- Helper Functions from Original Code (for API Calculator) ---
        function getContractDetails(symbol) { return { contractSize: 1, marginFactor: 1 }; }
        function getAssetType(symbol) {
             if (symbol.length === 6 && !symbol.startsWith('X') && !['AAPL', 'TSLA', 'GOOGL', 'US30', 'SPX500', 'NAS100', 'UK100', 'BTCUSD', 'ETHUSD', 'XRPUSD'].includes(symbol)) { return 'forex'; }
             else if (symbol.startsWith('XAU') || symbol.startsWith('XAG')) { return 'metal'; }
             else if (['AAPL', 'TSLA', 'GOOGL'].includes(symbol)) { return 'stock'; }
             else if (['US30', 'SPX500', 'NAS100', 'UK100'].includes(symbol)) { return 'index'; }
             else if (['BTCUSD', 'ETHUSD', 'XRPUSD'].includes(symbol)) { return 'crypto'; }
             return 'unknown';
        }
        function parseSymbol(symbol) {
             if (symbol.startsWith('XAU') || symbol.startsWith('XAG')) { return { base: symbol.substring(0, 3), quote: symbol.substring(3, 6) }; }
             else if (symbol.length === 6) { return { base: symbol.substring(0, 3), quote: symbol.substring(3, 6) }; }
             else {
                 if (['AAPL', 'TSLA', 'GOOGL', 'BTCUSD', 'ETHUSD', 'XRPUSD'].includes(symbol)) { return { base: 'USD', quote: 'USD' }; }
                 else if (symbol === 'UK100') { return { base: 'GBP', quote: 'USD' }; }
                 else if (['US30', 'SPX500', 'NAS100'].includes(symbol)) { return { base: 'USD', quote: 'USD' }; }
             }
             return { base: '', quote: '' };
        }
        function getPipPointDetails(symbol) {
             const assetType = getAssetType(symbol);
             let pipSize = 0;
             let valueLabel = 'N/A';
             let isPipCalculable = false;
             switch (assetType) {
                 case 'forex':
                     isPipCalculable = true; valueLabel = 'Pip Value';
                     if (symbol.includes('JPY')) { pipSize = 0.01; } else { pipSize = 0.0001; }
                     break;
                 case 'metal': case 'stock': case 'index': case 'crypto':
                     isPipCalculable = true; valueLabel = 'Point Value'; pipSize = 1;
                     break;
             }
             return { pipSize, valueLabel, isPipCalculable };
        }
        function updateTradeSizeLabel() {
            const selectedSymbol = currencyPairSelect.value;
            const assetType = getAssetType(selectedSymbol);
            let labelText = "Trade Size (Units):";
            let defaultValue = "1";
            switch (assetType) {
                case 'forex': labelText = "Trade Size (Base Currency Units):"; defaultValue = "100000"; break;
                case 'metal': labelText = "Trade Size (Ounces):"; defaultValue = "1"; break;
                case 'stock': labelText = "Trade Size (Shares):"; defaultValue = "1"; break;
                case 'index': labelText = "Trade Size (Contracts/Units):"; defaultValue = "1"; break;
                case 'crypto': labelText = "Trade Size (Coins):"; defaultValue = "1"; break;
            }
            tradeSizeLabel.textContent = labelText;
            tradeSizeInput.value = defaultValue;
            tradeSizeInput.placeholder = `e.g., ${defaultValue}`;
        }
    </script>
</body>
</html>
